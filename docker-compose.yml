services:
  # ======================================================
  # WAHA (WhatsApp API) - O "Ouvido"
  # ======================================================
  waha:
    image: devlikeapro/waha:latest
    container_name: waha
    restart: unless-stopped
    ports:
      - "3001:3000"
    env_file:
      - .env.waha
    volumes:
      - waha_sessions:/app/.sessions
    environment:
      - WHATSAPP_HOOK_URL=http://mcp-webhook:3002/webhook/waha
      - WHATSAPP_HOOK_EVENTS=message,message.any,state.change
    networks:
      - traefik_proxy
      - mcp_internal
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik_proxy"
      - "traefik.http.routers.waha.rule=Host(`waha.docaperformance.com.br`)"
      - "traefik.http.routers.waha.entrypoints=websecure"
      - "traefik.http.routers.waha.tls.certresolver=mytlschallenge"
      - "traefik.http.services.waha.loadbalancer.server.port=3000"

  # ======================================================
  # WEBHOOK SERVER (HTTP) - O "CÃ©rebro"
  # ======================================================
  mcp-webhook:
    build:
      context: .
      dockerfile: Dockerfile.webhook
    container_name: mcp-webhook
    restart: unless-stopped
    command: ["node", "dist/webhook.js"]
    env_file:
      - .env
    volumes:
      - ./config:/app/config
    environment:
      - WAHA_BASE_URL=http://waha:3000
      - GOOGLE_CREDENTIALS_PATH=/app/config/google-credentials.json
      - GOOGLE_TOKEN_PATH=/app/config/google-token.json
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - traefik_proxy
      - mcp_internal
    expose:
      - "3002"
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:3002/health >/dev/null 2>&1 || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 10
      start_period: 15s
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik_proxy"
      - "traefik.http.services.webhook3002.loadbalancer.server.port=3002"

      - "traefik.http.routers.mcp-webhook.rule=Host(`webhook.docaperformance.com.br`)"
      - "traefik.http.routers.mcp-webhook.entrypoints=websecure"
      - "traefik.http.routers.mcp-webhook.tls=true"
      - "traefik.http.routers.mcp-webhook.tls.certresolver=mytlschallenge"
      - "traefik.http.routers.mcp-webhook.service=webhook3002"

      - "traefik.http.routers.mcp-api.rule=Host(`api.docaperformance.com.br`)"
      - "traefik.http.routers.mcp-api.entrypoints=websecure"
      - "traefik.http.routers.mcp-api.tls=true"
      - "traefik.http.routers.mcp-api.tls.certresolver=mytlschallenge"
      - "traefik.http.routers.mcp-api.service=webhook3002"

  # ======================================================
  # DASHBOARD & CHAT (Frontends)
  # ======================================================
  mcp-dashboard:
    build:
      context: ./mcp-dashboard
      dockerfile: Dockerfile
    container_name: mcp-dashboard
    restart: unless-stopped
    networks:
      - traefik_proxy
      - mcp_internal
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik_proxy"
      - "traefik.http.routers.mcp-dashboard.rule=Host(`mcp.docaperformance.com.br`)"
      - "traefik.http.routers.mcp-dashboard.entrypoints=websecure"
      - "traefik.http.routers.mcp-dashboard.tls=true"
      - "traefik.http.routers.mcp-dashboard.tls.certresolver=mytlschallenge"
      - "traefik.http.services.mcp-dashboard.loadbalancer.server.port=80"

  mcp-dashboard-dev:
    build:
      context: ./mcp-dashboard
      dockerfile: Dockerfile.dev
    container_name: mcp-dashboard-dev
    restart: unless-stopped
    networks:
      - traefik_proxy
      - mcp_internal
    volumes:
      - ./mcp-dashboard:/app
      - /app/node_modules
    environment:
      - CHOKIDAR_USEPOLLING=true
      - WATCHPACK_POLLING=true
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik_proxy"
      - "traefik.http.routers.mcp-dashboard-dev.rule=Host(`dev.mcp.docaperformance.com.br`)"
      - "traefik.http.routers.mcp-dashboard-dev.entrypoints=websecure"
      - "traefik.http.routers.mcp-dashboard-dev.tls=true"
      - "traefik.http.routers.mcp-dashboard-dev.tls.certresolver=mytlschallenge"
      - "traefik.http.services.mcp-dashboard-dev.loadbalancer.server.port=5173"

  mcp-chat:
    image: nginx:alpine
    container_name: mcp-chat
    restart: unless-stopped
    networks:
      - traefik_proxy
      - mcp_internal
    volumes:
      - ./public/chat:/usr/share/nginx/html:ro
      - ./public/chat/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik_proxy"
      - "traefik.http.routers.mcp-chat.rule=Host(`chat.docaperformance.com.br`)"
      - "traefik.http.routers.mcp-chat.entrypoints=websecure"
      - "traefik.http.routers.mcp-chat.tls=true"
      - "traefik.http.routers.mcp-chat.tls.certresolver=mytlschallenge"
      - "traefik.http.services.mcp-chat.loadbalancer.server.port=80"

  mcp-backend:
    profiles: ["mcp"]
    build:
      context: .
      dockerfile: Dockerfile.mcp
    container_name: mcp-backend
    restart: unless-stopped
    env_file:
      - .env
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - mcp_internal

volumes:
  waha_sessions:

networks:
  traefik_proxy:
    external: true
  mcp_internal:
    driver: bridge
